<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dice Defense - Playground V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.8.0/fonts/remixicon.css" rel="stylesheet"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; overflow: hidden; }
        
        .tab-content { display: none; height: calc(100vh - 140px); overflow-y: auto; }
        .tab-content.active { display: flex; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        #game-canvas { background: #334155; border-radius: 12px; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
        .dice-unowned { filter: grayscale(100%); opacity: 0.6; }
        .stat-box { position: relative; height: 3.5rem; background-color: #f1f5f9; border-radius: 0.5rem; display: flex; align-items: center; padding: 0.5rem; }

        /* Ï£ºÏÇ¨ÏúÑ Ïä§ÌÉÄÏùº */
        .dice-face {
            background-color: #f1f5f9;
            border-radius: 22%;
            display: flex; align-items: center; justify-content: center;
            position: relative;
            box-shadow: inset 0 2px 3px rgba(255, 255, 255, 1), inset 0 -2px 5px rgba(0, 0, 0, 0.1), 0 4px 6px -1px rgba(0, 0, 0, 0.2);
            transition: transform 0.1s;
        }
        .dice-glossy::after {
            content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 45%;
            border-radius: 22% 22% 40% 40% / 30%;
            background: linear-gradient(180deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%);
            pointer-events: none; z-index: 10;
        }
        .dice-legend-style {
            border-width: 1px; border-style: solid;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.6), inset 0 0 0 2px var(--dice-color),
                inset 0 2px 4px rgba(255, 255, 255, 0.8), inset 0 -2px 5px rgba(0, 0, 0, 0.05),
                0 0 6px -1px var(--dice-color), 0 4px 6px -1px rgba(0, 0, 0, 0.2) !important;
        }

        /* [NEW] Í∞ïÌôî Í∞ÄÎä• Ìö®Í≥º (Î∞òÎîßÎ∂àÏù¥ ÌååÌã∞ÌÅ¥) */
        @keyframes firefly-float {
            0%, 100% { transform: translate(0, 0); opacity: 0; }
            50% { opacity: 1; }
            25% { transform: translate(10px, -10px); }
            75% { transform: translate(-10px, 10px); }
        }
        .firefly-container { position: absolute; inset: 0; pointer-events: none; overflow: hidden; border-radius: 0.75rem; }
        .firefly {
            position: absolute; width: 4px; height: 4px; background: #60a5fa;
            border-radius: 50%; box-shadow: 0 0 4px #60a5fa; opacity: 0;
        }
        .firefly:nth-child(1) { top: 20%; left: 20%; animation: firefly-float 3s infinite ease-in-out; animation-delay: 0s; }
        .firefly:nth-child(2) { top: 80%; left: 70%; animation: firefly-float 4s infinite ease-in-out; animation-delay: 1s; }
        .firefly:nth-child(3) { top: 40%; left: 80%; animation: firefly-float 3.5s infinite ease-in-out; animation-delay: 2s; }

        /* [NEW] Î†àÎ≤®ÏóÖ Î≤ÑÏä§Ìä∏ Ìö®Í≥º */
        @keyframes burst-ring {
            0% { transform: scale(0.8); opacity: 1; border-width: 4px; }
            100% { transform: scale(2); opacity: 0; border-width: 0; }
        }
        .burst-effect::after {
            content: ''; position: absolute; inset: -4px; border: 2px solid #60a5fa; border-radius: 0.75rem;
            animation: burst-ring 0.6s ease-out forwards; pointer-events: none;
        }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col">

    <nav class="flex-none h-16 bg-white flex justify-between items-center px-4 shadow-sm z-50">
        <div class="flex items-center gap-3">
            <button onclick="location.href='../home.html'" class="text-slate-500 hover:text-blue-600 transition-colors">
                <i class="ri-arrow-left-line text-2xl"></i>
            </button>
            <h1 class="text-lg font-bold text-slate-800 select-none">Dice Defense</h1>
        </div>
        <div class="flex gap-3 text-xs font-bold text-slate-600 bg-slate-100 px-3 py-1.5 rounded-full">
            <div class="flex items-center gap-1"><i class="ri-vip-diamond-fill text-blue-500 text-sm"></i> <span id="res-gem">0</span></div>
            <div class="w-px h-3 bg-slate-300"></div>
            <div class="flex items-center gap-1"><i class="ri-coins-fill text-yellow-500 text-sm"></i> <span id="res-gold">0</span></div>
            <div class="w-px h-3 bg-slate-300"></div>
            <div class="flex items-center gap-1"><i class="ri-coupon-3-fill text-purple-500 text-sm"></i> <span id="res-ticket">0</span></div>
        </div>
    </nav>

    <main class="flex-1 relative w-full max-w-lg mx-auto bg-slate-50 shadow-2xl overflow-hidden md:border-x md:border-slate-200">
        <div id="tab-shop" class="tab-content flex-col items-center p-4 space-y-4"></div>
        <div id="tab-deck" class="tab-content flex-col p-4"></div>
        <div id="tab-battle" class="tab-content active flex-col p-4 relative"></div>
        <div id="tab-event" class="tab-content flex-col p-4 space-y-4"></div>
        <div id="tab-clan" class="tab-content flex-col p-4 space-y-4"></div>

        <div id="dice-popup" onclick="if(event.target === this) closePopup()" class="absolute inset-0 z-50 bg-black/50 hidden items-center justify-center p-4 backdrop-blur-sm transition-opacity duration-200">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative animate-[fadeIn_0.2s_ease-out] flex flex-col max-h-[90vh] overflow-y-auto scrollbar-hide" onclick="event.stopPropagation()">
                <button onclick="closePopup()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 z-20 p-2">
                    <i class="ri-close-line text-2xl"></i>
                </button>
                
                <div class="flex items-center gap-4 mb-4">
                    <div id="popup-dice-icon-container" class="shrink-0 relative"></div>
                    <div>
                        <h3 id="popup-dice-name" class="text-xl font-bold text-slate-800">Dice Name</h3>
                        <div class="flex gap-2 mt-1">
                            <span id="popup-dice-rarity" class="text-[10px] font-bold px-2 py-0.5 rounded bg-slate-100 text-slate-500">Common</span>
                            <span id="popup-dice-class" class="text-[10px] font-bold px-2 py-0.5 rounded bg-blue-50 text-blue-600">Lv.1</span>
                        </div>
                    </div>
                </div>

                <p id="popup-dice-desc" class="text-xs text-slate-500 mb-4 bg-slate-50 p-2 rounded-lg">ÏÑ§Î™Ö...</p>
                <div id="popup-stats-grid" class="grid grid-cols-2 gap-2 mb-4"></div>

                <div class="flex gap-2 mb-4">
                    <button id="btn-view-class" onclick="toggleViewMode('class')" class="flex-1 py-2 rounded-lg text-xs font-bold border border-slate-200 text-slate-500 hover:bg-slate-50 transition-colors">ÌÅ¥ÎûòÏä§ ÏóÖ</button>
                    <button id="btn-view-power" onclick="toggleViewMode('power')" class="flex-1 py-2 rounded-lg text-xs font-bold border border-slate-200 text-slate-500 hover:bg-slate-50 transition-colors">ÌååÏõå ÏóÖ</button>
                </div>

                <div class="mt-auto pt-4 border-t border-slate-100">
                    <div class="flex justify-between text-xs mb-2">
                        <span class="text-slate-500">Î≥¥Ïú† Ïπ¥Îìú</span>
                        <span id="popup-dice-cards" class="font-bold text-blue-600">0 / 5</span>
                    </div>
                    <div class="w-full bg-slate-200 h-1.5 rounded-full overflow-hidden mb-4">
                        <div id="popup-progress-bar" class="bg-blue-500 h-full w-0 transition-all duration-500"></div>
                    </div>
                    <button id="popup-action-btn" class="relative w-full py-3 rounded-xl font-bold text-white shadow-lg transition-transform active:scale-95 flex items-center justify-center gap-2 overflow-hidden">
                        <span>ÏóÖÍ∑∏Î†àÏù¥Îìú</span>
                    </button>
                    <div id="popup-cost-info" class="text-xs text-slate-400 mt-2 text-center font-medium">ÎπÑÏö©: 1000Í≥®Îìú</div>
                </div>
            </div>
        </div>
    </main>

    <nav class="flex-none h-20 bg-white border-t border-slate-200 flex justify-between items-center px-1 pb-2 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] z-50">
        <button onclick="switchTab('shop')" class="nav-btn flex-1 flex flex-col items-center gap-1 text-slate-400 hover:text-slate-600 transition-colors" data-target="tab-shop"><i class="ri-store-3-fill text-2xl mb-0.5"></i><span class="text-[10px] font-bold">ÏÉÅÏ†ê</span></button>
        <button onclick="switchTab('deck')" class="nav-btn flex-1 flex flex-col items-center gap-1 text-slate-400 hover:text-slate-600 transition-colors" data-target="tab-deck"><i class="ri-layout-grid-fill text-2xl mb-0.5"></i><span class="text-[10px] font-bold">Îç±</span></button>
        <div class="w-16 relative flex justify-center"><button onclick="switchTab('battle')" class="nav-btn absolute -top-10 w-16 h-16 bg-blue-600 rounded-full flex flex-col items-center justify-center text-white shadow-lg shadow-blue-200 ring-4 ring-white transition-transform active:scale-95" data-target="tab-battle"><i class="ri-gamepad-fill text-3xl"></i></button></div>
        <button onclick="switchTab('event')" class="nav-btn flex-1 flex flex-col items-center gap-1 text-slate-400 hover:text-slate-600 transition-colors" data-target="tab-event"><i class="ri-gift-fill text-2xl mb-0.5"></i><span class="text-[10px] font-bold">Ïù¥Î≤§Ìä∏</span></button>
        <button onclick="switchTab('clan')" class="nav-btn flex-1 flex flex-col items-center gap-1 text-slate-400 hover:text-slate-600 transition-colors" data-target="tab-clan"><i class="ri-group-fill text-2xl mb-0.5"></i><span class="text-[10px] font-bold">ÌÅ¥Îûú</span></button>
    </nav>

    <script>
        const API_AUTH = "https://api.pyosh.cloud/api/auth";
        const API_DICE = "https://api.pyosh.cloud/api/dice";
        const myId = sessionStorage.getItem('username');

        async function loadComponents() {
            const tabs = [{id:'tab-shop',file:'lobby_shop.html'},{id:'tab-deck',file:'lobby_deck.html'},{id:'tab-battle',file:'lobby_start.html'},{id:'tab-event',file:'lobby_event.html'},{id:'tab-clan',file:'lobby_clan.html'}];
            await Promise.all(tabs.map(async(t)=>{try{const r=await fetch(t.file);if(r.ok)document.getElementById(t.id).innerHTML=await r.text()}catch(e){}}));
            initGameCanvas(); fetchMyResources();
        }

        const tabNames=['shop','deck','battle','event','clan']; let currentTabIdx=2; 
        function switchTab(name){
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
            document.getElementById(`tab-${name}`).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.toggle('text-blue-600',b.dataset.target===`tab-${name}`));
            if(name==='deck') fetchMyDice(); if(name==='shop') fetchMyResources();
        }
        async function fetchMyResources(){try{const r=await fetch(`${API_AUTH}/profile/${myId}`);if(r.ok){const d=await r.json();document.getElementById('res-gem').innerText=d.gems.toLocaleString();document.getElementById('res-gold').innerText=d.gold.toLocaleString();document.getElementById('res-ticket').innerText=d.tickets.toLocaleString();}}catch(e){}}
        async function addResource(t,a){await fetch(`${API_AUTH}/add-resource`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:myId,type:t,amount:a})});alert("ÏßÄÍ∏â ÏôÑÎ£å!");fetchMyResources();}
        async function summonDice(c){try{const r=await fetch(`${API_DICE}/summon`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:myId,count:c})});const d=await r.json();if(!r.ok)return alert(d.detail||"Ïò§Î•ò");const n=d.results.map(x=>`[${x.rarity}] ${x.name}`).join("\n");alert(`‚ú® ÏÜåÌôò Í≤∞Í≥º ‚ú®\n\n${n}`);fetchMyResources();}catch(e){alert("Ïò§Î•ò");}}

        // --- ÏãúÍ∞ÅÏ†Å Ìö®Í≥º Ìó¨Ìçº ---
        function getDiceVisualClasses(dice) {
            let borderColor = dice.color.replace('bg-', 'border-');
            if(dice.color.includes('gradient')) borderColor = 'border-slate-300';
            let effectClasses = "dice-glossy"; let customStyle = "";
            if (dice.rarity === 'Legend') {
                effectClasses += " dice-legend-style";
                let hexColor = dice.id === 'typhoon' ? "#0f766e" : "#fbbf24"; 
                customStyle = `--dice-color: ${hexColor}; border-color: ${hexColor};`;
                borderColor = ""; 
            }
            return { borderColor, effectClasses, customStyle };
        }

        function renderDiceIcon(dice, sizeClass="w-10 h-10") {
            const { borderColor, effectClasses, customStyle } = getDiceVisualClasses(dice);
            const borderBase = dice.rarity === 'Legend' ? '' : 'border-2';
            const symbolIcon = dice.symbol || "ri-dice-fill";
            const bgSymbolHtml = `<div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-30 text-slate-400 z-0"><i class="${symbolIcon} text-4xl"></i></div>`;
            return `<div class="dice-face ${sizeClass} ${borderBase} ${borderColor} ${effectClasses}" style="${customStyle}">${bgSymbolHtml}<div class="dice-content w-[25%] h-[25%] rounded-full ${dice.color} shadow-sm z-10"></div></div>`;
        }

        // [NEW] Îì±Í∏âÎ≥Ñ Î∞∞Í≤Ω ÏïÑÏù¥ÏΩò Î∞è ÏÉâÏÉÅ
        function getRarityBgIcon(rarity) {
            switch(rarity) {
                case 'Legend': return 'ri-vip-crown-line';
                case 'Hero': return 'ri-sword-line';
                case 'Rare': return 'ri-shield-line';
                default: return 'ri-focus-line';
            }
        }
        function getRarityDotColor(rarity) {
            switch(rarity) {
                case 'Legend': return 'bg-yellow-400'; // Ìô©Í∏à
                case 'Hero': return 'bg-purple-500';   // Î≥¥Îùº
                case 'Rare': return 'bg-blue-500';     // ÌååÎûë
                default: return 'bg-gray-400';         // ÌöåÏÉâ
            }
        }

        // --- Îç± Î°úÏßÅ ---
        let currentDiceList = [], currentSelectedDice = null, currentViewMode = null;
        async function fetchMyDice() { try { const r=await fetch(`${API_DICE}/list/${myId}`); if(r.ok){ currentDiceList=await r.json(); renderDiceGrid(currentDiceList); } } catch(e){} }
        
        function renderDiceGrid(list) {
            const grid = document.getElementById('dice-list-grid'); if(!grid) return;
            const countEl = document.getElementById('dice-count'); grid.innerHTML = ""; let ownedCount = 0;
            
            // ÌòÑÏû¨ Î≥¥Ïú† Í≥®Îìú (Í∞ïÌôî Í∞ÄÎä• Ïó¨Î∂Ä ÌôïÏù∏Ïö©)
            const currentGold = parseInt(document.getElementById('res-gold').innerText.replace(/,/g, '')) || 0;

            list.forEach(dice => {
                const isOwned = dice.class_level > 0;
                if(isOwned) ownedCount++;
                
                // Í∞ïÌôî Í∞ÄÎä• Ïó¨Î∂Ä Ï≤¥ÌÅ¨
                let isUpgradeable = false;
                if (isOwned) {
                    const reqCards = dice.class_level === 0 ? 1 : 5; // Ìï¥Í∏àÏùÄ 1Ïû•, Í∞ïÌôîÎäî 5Ïû•
                    const reqGold = dice.class_level * 1000;
                    if (dice.quantity >= reqCards && (dice.class_level === 0 || currentGold >= reqGold)) {
                        isUpgradeable = true;
                    }
                }

                const iconHtml = renderDiceIcon(dice, "w-12 h-12");
                const rarityBgIcon = getRarityBgIcon(dice.rarity);
                const rarityDotColor = getRarityDotColor(dice.rarity);

                // [NEW] Í∞ïÌôî Í∞ÄÎä• Ïãú Ïä§ÌÉÄÏùº: ÌååÎûÄ ÌÖåÎëêÎ¶¨ + ÌååÌã∞ÌÅ¥
                const borderClass = isUpgradeable ? 'border-blue-400 ring-1 ring-blue-200' : 'border-slate-100';
                const particleHtml = isUpgradeable ? `
                    <div class="firefly-container">
                        <div class="firefly"></div><div class="firefly"></div><div class="firefly"></div>
                    </div>` : '';

                const cardHtml = `
                <div class="aspect-square rounded-xl shadow-sm border-2 ${borderClass} flex flex-col items-center justify-center relative overflow-hidden transition-transform active:scale-95 cursor-pointer ${isOwned ? 'bg-white hover:bg-slate-50' : 'bg-slate-100 dice-unowned'}" 
                     onclick="showDiceDetail('${dice.id}')">
                    
                    <div class="absolute inset-0 flex items-center justify-center text-slate-100 pointer-events-none -z-0">
                        <i class="${rarityBgIcon} text-7xl opacity-50"></i>
                    </div>
                    
                    ${particleHtml}

                    <div class="mb-1 z-10">${iconHtml}</div>
                    <div class="font-bold text-xs text-slate-700 z-10">${dice.name}</div>
                    ${isOwned ? `<span class="text-[10px] font-bold text-slate-600 bg-slate-100 px-1.5 rounded mt-1 z-10">Lv.${dice.class_level}</span>` : `<span class="text-[10px] font-bold text-slate-400 mt-1 z-10">ÎØ∏ÌöçÎìù</span>`}
                    ${isOwned ? `<span class="text-[9px] text-slate-400 absolute bottom-1 right-2 z-10">${dice.quantity}Ïû•</span>` : ""}
                    
                    <div class="absolute top-2 right-2 w-2 h-2 rounded-full ${rarityDotColor} z-10 shadow-sm"></div>
                </div>`;
                grid.innerHTML += cardHtml;
            });
            if(countEl) countEl.innerText = `${ownedCount}/${list.length}`;
        }

        // --- ÏÉÅÏÑ∏ ÌåùÏóÖ ---
        function showDiceDetail(diceId) {
            const dice = currentDiceList.find(d => d.id === diceId); if(!dice) return; currentSelectedDice = dice;
            document.getElementById('popup-dice-name').innerText = dice.name;
            document.getElementById('popup-dice-desc').innerText = dice.desc;
            document.getElementById('popup-dice-rarity').innerText = dice.rarity;
            document.getElementById('popup-dice-class').innerText = dice.class_level > 0 ? `Lv.${dice.class_level}` : "ÎØ∏Î≥¥Ïú†";
            
            // ÌåùÏóÖ ÏïÑÏù¥ÏΩò (ÌÅ¨Í≤å)
            let iconHtml = renderDiceIcon(dice, "w-16 h-16");
            iconHtml = iconHtml.replace("text-4xl", "text-6xl"); 
            document.getElementById('popup-dice-icon-container').innerHTML = iconHtml;

            // [NEW] ÌåùÏóÖ ÎÇ¥ Í∞ïÌôî Í∞ÄÎä• Ïãú ÌååÌã∞ÌÅ¥ Ï∂îÍ∞Ä
            const currentGold = parseInt(document.getElementById('res-gold').innerText.replace(/,/g, '')) || 0;
            const btn = document.getElementById('popup-action-btn'); 
            const costInfo = document.getElementById('popup-cost-info'); 
            const progress = document.getElementById('popup-progress-bar');
            const iconContainer = document.getElementById('popup-dice-icon-container');

            // Í∏∞Ï°¥ ÌååÌã∞ÌÅ¥ Ï†úÍ±∞ ÌõÑ Ïû¨ÏÉùÏÑ±
            const existingParticles = iconContainer.querySelector('.firefly-container');
            if(existingParticles) existingParticles.remove();

            let canUpgrade = false, reqCards = 0, reqGold = 0;
            
            if(dice.class_level === 0) { // Ìï¥Í∏à
                reqCards = 1; 
                document.getElementById('popup-dice-cards').innerText = `${dice.quantity} / ${reqCards}`; 
                progress.style.width = `${Math.min((dice.quantity/reqCards)*100, 100)}%`;
                if(dice.quantity >= reqCards) { canUpgrade = true; btn.className = "w-full py-3 rounded-xl font-bold text-white shadow-lg active:scale-95 flex items-center justify-center gap-2 bg-green-500 hover:bg-green-600"; btn.innerHTML = `<span>üîì Ìï¥Í∏àÌïòÍ∏∞</span>`; costInfo.innerText = "ÎπÑÏö©: Ïπ¥Îìú 1Ïû•"; }
                else { btn.className = "w-full py-3 rounded-xl font-bold text-white shadow-lg bg-slate-300 cursor-not-allowed"; btn.innerHTML = `<span>Ïπ¥Îìú Î∂ÄÏ°±</span>`; costInfo.innerText = "Ïπ¥ÎìúÎ•º Îçî Î™®ÏúºÏÑ∏Ïöî"; }
            } else { // Í∞ïÌôî
                reqCards = 5; reqGold = dice.class_level * 1000; 
                document.getElementById('popup-dice-cards').innerText = `${dice.quantity} / ${reqCards}`; 
                progress.style.width = `${Math.min((dice.quantity/reqCards)*100, 100)}%`;
                
                if(dice.quantity >= reqCards && currentGold >= reqGold) { 
                    canUpgrade = true; 
                    btn.className = "w-full py-3 rounded-xl font-bold text-white shadow-lg active:scale-95 flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700"; 
                    btn.innerHTML = `<span>‚¨ÜÔ∏è Î†àÎ≤®ÏóÖ</span>`; 
                    costInfo.innerText = `ÎπÑÏö©: ${reqGold.toLocaleString()} Í≥®Îìú`; 
                }
                else { 
                    btn.className = "w-full py-3 rounded-xl font-bold text-white shadow-lg bg-slate-300 cursor-not-allowed"; 
                    btn.innerHTML = dice.quantity < reqCards ? "Ïπ¥Îìú Î∂ÄÏ°±" : "Í≥®Îìú Î∂ÄÏ°±"; 
                    costInfo.innerText = `ÌïÑÏöî: Ïπ¥Îìú 5Ïû•, ${reqGold.toLocaleString()} Í≥®Îìú`; 
                }
            }

            // Í∞ïÌôî Í∞ÄÎä•ÌïòÎ©¥ ÌåùÏóÖ ÏïÑÏù¥ÏΩòÏóêÎèÑ ÌååÌã∞ÌÅ¥ Î∞è ÌÖåÎëêÎ¶¨ Ìö®Í≥º
            if(canUpgrade) {
                iconContainer.innerHTML += `<div class="firefly-container" style="border-radius: 1rem;"><div class="firefly"></div><div class="firefly"></div></div>`;
            }

            btn.onclick = canUpgrade ? () => upgradeDice(dice.id) : null; 
            btn.disabled = !canUpgrade;
            
            currentViewMode = canUpgrade && dice.class_level > 0 ? 'class' : null; 
            updateStatsView();
            document.getElementById('dice-popup').classList.remove('hidden'); document.getElementById('dice-popup').classList.add('flex');
        }

        // --- [NEW] Í∞ïÌôî Î°úÏßÅ Í∞úÏÑ† (ÌåùÏóÖ Ïú†ÏßÄ + Ïó∞Ï∂ú) ---
        async function upgradeDice(diceId) {
            try {
                const res = await fetch(`${API_DICE}/upgrade`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ username: myId, dice_id: diceId }) });
                const data = await res.json();
                
                if(res.ok) {
                    // 1. ÏÑ±Í≥µ Ïó∞Ï∂ú (Î≤ÑÌäº Î≤ÑÏä§Ìä∏ Ìö®Í≥º)
                    const btn = document.getElementById('popup-action-btn');
                    btn.classList.add('burst-effect');
                    setTimeout(() => btn.classList.remove('burst-effect'), 600);

                    // 2. Îç∞Ïù¥ÌÑ∞ Î∞±Í∑∏ÎùºÏö¥Îìú Í∞±Ïã†
                    await fetchMyResources(); // Í≥®Îìú Ï∞®Í∞ê Î∞òÏòÅ
                    
                    // 3. Î¶¨Ïä§Ìä∏ Í∞±Ïã† (ÏÑúÎ≤ÑÏóêÏÑú Îã§Ïãú Î∞õÏïÑÏò¥)
                    const listRes = await fetch(`${API_DICE}/list/${myId}`);
                    if(listRes.ok) {
                        currentDiceList = await listRes.json();
                        renderDiceGrid(currentDiceList); // Îí§Ï™Ω Í∑∏Î¶¨Îìú Í∞±Ïã†
                        
                        // 4. ÌåùÏóÖ ÎÇ¥Ïö© Í∞±Ïã† (Îã´ÏßÄ ÏïäÏùå!)
                        // ÌòÑÏû¨ Î≥¥Í≥† ÏûàÎäî Ï£ºÏÇ¨ÏúÑ Îç∞Ïù¥ÌÑ∞ Ï∞æÏïÑÏÑú Í∞±Ïã†
                        const updatedDice = currentDiceList.find(d => d.id === diceId);
                        if(updatedDice) {
                            currentSelectedDice = updatedDice; // Ï∞∏Ï°∞ Í∞±Ïã†
                            
                            // Î†àÎ≤®/Ïπ¥Îìú Ï†ïÎ≥¥ Í∞±Ïã†
                            document.getElementById('popup-dice-class').innerText = `Lv.${updatedDice.class_level}`;
                            
                            // Î≤ÑÌäº Î∞è ÏÉÅÌÉú Ïû¨Í≥ÑÏÇ∞ (showDiceDetail Î°úÏßÅ ÏùºÎ∂Ä Ïû¨ÏÇ¨Ïö©ÌïòÍ±∞ÎÇò Î≥ÑÎèÑ Ìï®Ïàò Î∂ÑÎ¶¨ Ï∂îÏ≤ú, Ïó¨Í∏∞ÏÑ† ÏßÅÏ†ë UI ÏóÖÎç∞Ïù¥Ìä∏)
                            // ÌåùÏóÖ Ï†ÑÏ≤¥ Î¶¨ÌîÑÎ†àÏãúÎ•º ÏúÑÌï¥ showDiceDetail Ïû¨Ìò∏Ï∂úÏù¥ Í∞ÄÏû• ÍπîÎÅîÌï®
                            showDiceDetail(diceId);
                        }
                    }
                } else {
                     alert(data.detail || "Ïò§Î•ò");
                }
            } catch(e) { alert("ÌÜµÏã† Ïò§Î•ò"); }
        }

        function updateStatsView() {
            if(!currentSelectedDice) return;
            const dice = currentSelectedDice; const stats = dice.stats; const level = Math.max(1, dice.class_level);
            const grid = document.getElementById('popup-stats-grid'); grid.innerHTML = "";
            addStatBox(grid, "Í≥µÍ≤©Î†•", "ri-sword-fill", stats.atk, level);
            addStatBox(grid, "Í≥µÍ≤©ÏÜçÎèÑ", "ri-speed-fill", stats.speed, level, "s");
            addStatBoxStatic(grid, "ÌÉÄÍ≤ü", "ri-crosshair-2-fill", stats.target);
            if(stats.specials) { stats.specials.forEach(sp => { addStatBox(grid, sp.name, sp.icon, sp, level, "", sp.format); }); }
            const filled = 3 + (stats.specials ? stats.specials.length : 0);
            for(let i=filled; i<6; i++) { grid.innerHTML += `<div class="stat-box"><div class="text-slate-300 mx-auto text-xl">-</div></div>`; }
            const btnClass = document.getElementById('btn-view-class'); const btnPower = document.getElementById('btn-view-power');
            btnClass.className = `flex-1 py-2 rounded-lg text-xs font-bold border transition-colors ${currentViewMode==='class' ? 'bg-green-100 border-green-300 text-green-700' : 'border-slate-200 text-slate-500 hover:bg-slate-50'}`;
            btnPower.className = `flex-1 py-2 rounded-lg text-xs font-bold border transition-colors ${currentViewMode==='power' ? 'bg-orange-100 border-orange-300 text-orange-700' : 'border-slate-200 text-slate-500 hover:bg-slate-50'}`;
        }

        function toggleViewMode(mode) { currentViewMode = (currentViewMode === mode) ? null : mode; updateStatsView(); }
        function addStatBox(grid, name, iconClass, statData, level, unitSuffix="", formatStr="{}") {
            if(statData === "-" || !statData.base) { grid.innerHTML += `<div class="stat-box justify-between"><i class="${iconClass} text-slate-400 text-lg w-6 text-center"></i><div class="text-right"><div class="text-[10px] text-slate-400 font-bold">${name}</div><div class="text-lg font-bold text-slate-300">-</div></div></div>`; return; }
            const baseVal = statData.base; const cInc = statData.c || 0; const pInc = statData.p || 0;
            let currentVal = parseFloat((baseVal + (level - 1) * cInc).toFixed(2));
            let displayVal = currentVal; let diffHtml = "";
            if (currentViewMode === 'class' && cInc !== 0) { diffHtml = `<span class="text-[10px] text-green-600 ml-1">(${cInc > 0 ? "+" : ""}${cInc})</span>`; }
            else if (currentViewMode === 'power' && pInc !== 0) { diffHtml = `<span class="text-[10px] text-orange-500 ml-1">(${pInc > 0 ? "+" : ""}${pInc})</span>`; }
            let finalStr = formatStr.replace("{}", displayVal); if(unitSuffix && !formatStr.includes(unitSuffix)) finalStr += unitSuffix;
            grid.innerHTML += `<div class="stat-box justify-between"><i class="${iconClass} text-slate-600 text-lg w-6 text-center"></i><div class="text-right"><div class="text-[10px] text-slate-400 font-bold">${name}</div><div class="text-sm font-bold text-slate-700 flex items-center justify-end">${finalStr} ${diffHtml}</div></div></div>`;
        }
        function addStatBoxStatic(grid, name, iconClass, val) { grid.innerHTML += `<div class="stat-box justify-between"><i class="${iconClass} text-slate-600 text-lg w-6 text-center"></i><div class="text-right"><div class="text-[10px] text-slate-400 font-bold">${name}</div><div class="text-sm font-bold text-slate-700">${val}</div></div></div>`; }
        function closePopup() { document.getElementById('dice-popup').classList.add('hidden'); document.getElementById('dice-popup').classList.remove('flex'); currentSelectedDice = null; }
        
        let socket, canvas, ctx; function initGameCanvas() { canvas = document.getElementById('game-canvas'); if(canvas) { ctx = canvas.getContext('2d'); requestAnimationFrame(renderLoop); } }
        function startGame(mode) { } function renderLoop() { if(!ctx) return; ctx.clearRect(0,0,canvas.width,canvas.height); ctx.strokeStyle='#475569'; ctx.lineWidth=1; const s=canvas.width/5; for(let x=0;x<5;x++)for(let y=0;y<3;y++)ctx.strokeRect(x*s,(canvas.height-s*3)/2+y*s,s,s); requestAnimationFrame(renderLoop); } function spawnDice() { }
        window.onload = function() { if(!myId) { location.href = '../index.html'; return; } loadComponents(); };
    </script>
</body>
</html>