<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>마이페이지 - Playground V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; }
        .tab-btn.active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: bold; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white rounded-3xl shadow-xl w-full max-w-lg overflow-hidden">
        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
            <h2 class="text-xl font-bold text-slate-800">마이페이지</h2>
            <button onclick="location.href='home.html'" class="text-slate-400 hover:text-slate-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div class="flex border-b border-slate-100">
            <button onclick="showTab('account')" id="tab-account" class="tab-btn flex-1 py-4 text-sm text-slate-500 hover:bg-slate-50 transition-colors active">내 계정</button>
            <button onclick="showTab('security')" id="tab-security" class="tab-btn flex-1 py-4 text-sm text-slate-500 hover:bg-slate-50 transition-colors">보안 설정</button>
            <button onclick="showTab('delete')" id="tab-delete" class="tab-btn flex-1 py-4 text-sm text-slate-500 hover:bg-slate-50 transition-colors">계정 탈퇴</button>
        </div>

        <div class="p-8">
            <div id="content-account" class="tab-content space-y-8">
                
                <div class="flex flex-col items-center pb-6 border-b border-slate-100">
                    <div class="relative group cursor-pointer mb-3" onclick="document.getElementById('file-input').click()">
                        <div class="w-24 h-24 rounded-full overflow-hidden border-2 border-slate-100 shadow-sm">
                            <img id="current-profile-img" src="https://via.placeholder.com/150?text=USER" class="w-full h-full object-cover">
                        </div>
                        <div class="absolute inset-0 bg-black bg-opacity-40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <i class="fas fa-camera text-white"></i>
                        </div>
                    </div>
                    <input type="file" id="file-input" class="hidden" accept="image/*" onchange="openCropper(this)">
                    <button onclick="saveImageOnly()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-black transition-colors">
                        사진만 저장
                    </button>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">닉네임 변경</label>
                    <div class="flex gap-2">
                        <input id="input-nick" type="text" class="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-blue-500" placeholder="닉네임 입력">
                        <button onclick="checkNick()" class="bg-slate-200 text-slate-600 px-4 rounded-xl text-xs font-bold hover:bg-slate-300">중복확인</button>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-1 ml-1">* 한글/영문/숫자 포함 1~15자 이내</p>
                    
                    <button onclick="saveNickOnly()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl mt-3 shadow-md shadow-blue-100 transition-all">
                        닉네임 저장
                    </button>
                </div>
            </div>

            <div id="content-security" class="tab-content hidden space-y-4">
                <div class="bg-blue-50 p-4 rounded-xl text-xs text-blue-600 mb-4">
                    <i class="fas fa-info-circle mr-1"></i> 본인 확인을 위해 2차 비밀번호와 현재 비밀번호가 필요합니다.
                </div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">현재 비밀번호</label><input id="old-pw" type="password" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm"></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">2차 비밀번호 (4자리)</label><input id="birth-check" type="text" maxlength="4" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm" placeholder="ex. 1225"></div>
                <hr class="border-slate-100 my-4">
                <div><label class="block text-xs font-bold text-slate-500 mb-1">새 비밀번호</label><input id="new-pw" type="password" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm"></div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1">새 비밀번호 확인</label><input id="new-pw-confirm" type="password" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm"></div>
                <button onclick="changePassword()" class="w-full bg-slate-800 hover:bg-black text-white font-bold py-4 rounded-xl transition-all mt-4">비밀번호 변경</button>
            </div>

            <div id="content-delete" class="tab-content hidden text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500 text-2xl"><i class="fas fa-user-slash"></i></div>
                <h3 class="text-lg font-bold text-slate-800 mb-2">정말 탈퇴하시겠습니까?</h3>
                <p class="text-sm text-slate-500 mb-8 leading-relaxed">탈퇴 요청 시 즉시 로그아웃되며,<br><span class="text-red-500 font-bold">관리자 승인 후 모든 데이터가 영구 삭제</span>됩니다.</p>
                <button onclick="requestWithdraw()" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-red-200 transition-all">계정 탈퇴 요청</button>
            </div>
        </div>
    </div>

    <div id="cropper-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden z-50 flex flex-col items-center justify-center p-4">
        <div class="bg-white p-4 rounded-xl w-full max-w-md h-[400px] flex flex-col">
            <div class="flex-1 bg-slate-100 overflow-hidden relative">
                <img id="cropper-image" class="max-w-full">
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="closeCropper()" class="px-4 py-2 text-sm text-slate-500">취소</button>
                <button onclick="cropImage()" class="px-6 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold">자르기</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script>
        const API = "https://api.pyosh.cloud/api/auth";
        const myId = sessionStorage.getItem('username');
        let cropper = null;
        let finalImageBase64 = null; // 잘라낸 이미지 데이터
        let isNickChecked = true; 

        window.onload = async function() {
            if(!myId) { alert("로그인이 필요합니다."); location.href='index.html'; return; }
            try {
                const res = await fetch(`${API}/profile/${myId}`);
                if(res.ok) {
                    const data = await res.json();
                    document.getElementById('input-nick').value = data.nickname;
                    if(data.profile_image) {
                        document.getElementById('current-profile-img').src = data.profile_image;
                    }
                }
            } catch(e) {}
        };

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // --- 이미지 관련 ---
        function openCropper(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('cropper-image');
                    img.src = e.target.result;
                    document.getElementById('cropper-modal').classList.remove('hidden');
                    if(cropper) cropper.destroy();
                    cropper = new Cropper(img, { aspectRatio: 1, viewMode: 1 });
                }
                reader.readAsDataURL(input.files[0]);
            }
        }
        function closeCropper() {
            document.getElementById('cropper-modal').classList.add('hidden');
            if(cropper) cropper.destroy();
            document.getElementById('file-input').value = "";
        }
        function cropImage() {
            const canvas = cropper.getCroppedCanvas({ width: 200, height: 200 });
            finalImageBase64 = canvas.toDataURL('image/jpeg', 0.8);
            document.getElementById('current-profile-img').src = finalImageBase64;
            closeCropper();
        }

        // [신규] 사진만 저장
        async function saveImageOnly() {
            if(!finalImageBase64) { alert("변경할 사진을 먼저 선택해주세요."); return; }
            const res = await fetch(`${API}/update-profile`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: myId, profile_image: finalImageBase64 }) // 닉네임 미포함
            });
            if(res.ok) { alert("사진이 저장되었습니다."); location.reload(); }
            else { alert("저장 실패"); }
        }

        // --- 닉네임 관련 ---
        async function checkNick() {
            const nick = document.getElementById('input-nick').value;
            if(!nick) return;
            const res = await fetch(`${API}/check-nick/${nick}`);
            const data = await res.json();
            if(data.available) { alert("사용 가능한 닉네임입니다."); isNickChecked = true; }
            else { alert(data.message); isNickChecked = false; }
        }

        // [신규] 닉네임만 저장
        async function saveNickOnly() {
            if(!isNickChecked) { alert("중복 확인을 해주세요."); return; }
            const nick = document.getElementById('input-nick').value;
            const res = await fetch(`${API}/update-profile`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: myId, nickname: nick }) // 사진 미포함
            });
            if(res.ok) { 
                alert("닉네임이 변경되었습니다."); 
                sessionStorage.setItem('nickname', nick);
                location.reload();
            } else { alert("저장 실패: " + (await res.json()).detail); }
        }

        // --- 보안 및 탈퇴 ---
        async function changePassword() {
            const oldPw = document.getElementById('old-pw').value;
            const birth = document.getElementById('birth-check').value;
            const newPw = document.getElementById('new-pw').value;
            const confirmPw = document.getElementById('new-pw-confirm').value;
            if(newPw !== confirmPw) { alert("새 비밀번호 불일치"); return; }
            if(!oldPw || !birth || !newPw) { alert("정보를 모두 입력하세요"); return; }
            const res = await fetch(`${API}/change-password`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: myId, old_password: oldPw, birthdate: birth, new_password: newPw })
            });
            if(res.ok) { alert("변경 완료. 다시 로그인해주세요."); sessionStorage.clear(); location.href = 'index.html'; }
            else { alert((await res.json()).detail); }
        }

        async function requestWithdraw() {
            if(!confirm("정말로 탈퇴 요청을 하시겠습니까?")) return;
            const res = await fetch(`${API}/withdraw`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: myId, password: "", nickname: "" })
            });
            if(res.ok) { alert("요청 접수됨. 로그아웃됩니다."); sessionStorage.clear(); location.href = 'index.html'; }
        }
    </script>
</body>
</html>