<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playground V3 - Îã§Ïù¥Ïä§ ÎîîÌéúÏä§</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; overflow: hidden; }
        
        /* ÌÉ≠ Ï†ÑÌôò Î∞è ÌåùÏóÖ Ïï†ÎãàÎ©îÏù¥ÏÖò */
        .tab-screen { display: none; height: 100%; width: 100%; flex-direction: column; }
        .tab-screen.active { display: flex; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .animate-pulse-red { animation: pulseRed 2s infinite; }
        @keyframes pulseRed {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* Ïä§ÌÅ¨Î°§Î∞î Ïà®ÍπÄ */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        #game-canvas-container {
            width: 100%; max-width: 500px; aspect-ratio: 9/16; 
            background: #222; border-radius: 12px; position: relative; overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col select-none">

    <nav class="h-14 bg-white flex justify-between items-center px-4 shadow-sm z-50 shrink-0 border-b border-slate-200">
        <div class="flex items-center gap-3">
            <button onclick="exitGame()" class="text-slate-400 hover:text-red-500 transition-colors">
                <i class="fas fa-chevron-left text-lg"></i>
            </button>
            <h1 class="text-lg font-bold text-blue-600">Dice Defense</h1>
        </div>
        
        <div class="flex items-center gap-2">
            <div class="bg-slate-100 px-2 py-1 rounded-md text-xs font-bold text-slate-600 border border-slate-200">
                <i class="fas fa-coins text-yellow-500 mr-1"></i> <span id="ui-gold">0</span>
            </div>
            <div class="bg-slate-100 px-2 py-1 rounded-md text-xs font-bold text-slate-600 border border-slate-200">
                <i class="fas fa-gem text-blue-400 mr-1"></i> <span id="ui-gem">0</span>
            </div>
        </div>
    </nav>

    <main class="flex-1 relative w-full max-w-2xl mx-auto overflow-hidden bg-slate-50">
        
        <button onclick="moveTab(-1)" class="absolute left-2 top-1/2 -translate-y-1/2 z-10 w-8 h-8 bg-white/90 rounded-full shadow hover:bg-white flex items-center justify-center text-slate-400 hover:text-blue-600 transition-all border border-slate-100">
            <i class="fas fa-chevron-left"></i>
        </button>
        <button onclick="moveTab(1)" class="absolute right-2 top-1/2 -translate-y-1/2 z-10 w-8 h-8 bg-white/90 rounded-full shadow hover:bg-white flex items-center justify-center text-slate-400 hover:text-blue-600 transition-all border border-slate-100">
            <i class="fas fa-chevron-right"></i>
        </button>

        <div id="screen-0" class="tab-screen items-center justify-center">
            <i class="fas fa-store text-5xl text-orange-200 mb-3"></i>
            <h2 class="text-xl font-bold text-slate-600">ÏÉÅÏ†ê</h2>
            <p class="text-slate-400 text-xs">Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§.</p>
        </div>

        <div id="screen-1" class="tab-screen">
            <div class="bg-white p-5 pb-3 shadow-sm border-b border-slate-200 z-10">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-bold text-slate-700">BATTLE DECK</h3>
                    <button id="deck-alert" onclick="alert('Ï†ÑÌà¨Î•º ÏãúÏûëÌïòÎ†§Î©¥ Îç± 5Ïπ∏ÏùÑ Î™®Îëê Ï±ÑÏõåÏïº Ìï©ÎãàÎã§.')" class="hidden text-red-500 text-xs font-bold animate-pulse hover:bg-red-50 px-2 py-0.5 rounded transition-colors">
                        <i class="fas fa-exclamation-circle mr-1"></i> Îç± ÏÑ§Ï†ï ÌïÑÏöî
                    </button>
                </div>
                
                <div class="flex gap-2 h-24 sm:h-28">
                    <div id="deck-slots-container" class="flex w-full gap-2"></div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 scrollbar-hide pb-20">
                
                <h4 class="text-xs font-bold text-slate-500 mb-2 px-1">Î≥¥Ïú† Ï£ºÏÇ¨ÏúÑ</h4>
                <div id="owned-dice-grid" class="grid grid-cols-4 gap-2 mb-6">
                    </div>

                <h4 class="text-xs font-bold text-slate-400 mb-2 px-1">ÎØ∏Î≥¥Ïú†</h4>
                <div id="unowned-dice-grid" class="grid grid-cols-4 gap-2 opacity-60 grayscale">
                    </div>
                <div class="h-10"></div>
            </div>
        </div>

        <div id="screen-2" class="tab-screen active bg-white">
            <div id="lobby-view" class="flex flex-col items-center justify-center h-full w-full p-6">
                <div class="text-center mb-10">
                    <h2 class="text-3xl font-extrabold text-slate-800 tracking-tight">BATTLE READY</h2>
                    <p class="text-slate-400 text-sm mt-1">ÏµúÍ∞ïÏùò Îç±ÏúºÎ°ú Ï†ÅÏùÑ ÎßâÏïÑÎÇ¥ÏÑ∏Ïöî!</p>
                </div>
                
                <button onclick="tryStartGame()" class="w-full max-w-xs py-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-2xl font-bold text-lg shadow-lg shadow-blue-200 hover:scale-[1.02] active:scale-95 transition-all">
                    GAME START
                </button>
                
                <div class="mt-8 flex gap-4 text-xs font-bold text-slate-500">
                    <div class="flex flex-col items-center gap-1 cursor-pointer hover:text-blue-500">
                        <div class="w-12 h-12 bg-slate-50 rounded-full flex items-center justify-center border border-slate-200 text-xl">üé≤</div>
                        <span>ÎΩëÍ∏∞</span>
                    </div>
                    <div class="flex flex-col items-center gap-1 cursor-pointer hover:text-blue-500">
                        <div class="w-12 h-12 bg-slate-50 rounded-full flex items-center justify-center border border-slate-200 text-xl">üèÜ</div>
                        <span>Îû≠ÌÇπ</span>
                    </div>
                </div>
            </div>
            <div id="game-view" class="hidden w-full h-full relative bg-slate-800 flex items-center justify-center">
                <div id="game-canvas-container">
                    <canvas id="gameCanvas" width="500" height="888" class="w-full h-full"></canvas>
                </div>
            </div>
        </div>

        <div id="screen-3" class="tab-screen items-center justify-center">
            <i class="fas fa-users text-5xl text-green-200 mb-3"></i>
            <h2 class="text-xl font-bold text-slate-600">Î©ÄÌã∞ÌîåÎ†àÏù¥</h2>
            <p class="text-slate-400 text-xs">Îß§Ïπ≠ ÏãúÏä§ÌÖú Ï§ÄÎπÑ Ï§ë...</p>
        </div>

    </main>

    <footer class="h-16 bg-white border-t border-slate-100 grid grid-cols-4 shrink-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-50">
        <button onclick="switchTab(0)" class="tab-btn text-slate-400 flex flex-col items-center justify-center hover:bg-slate-50" data-idx="0">
            <i class="fas fa-store mb-1"></i> <span class="text-[10px]">ÏÉÅÏ†ê</span>
        </button>
        <button onclick="switchTab(1)" class="tab-btn text-slate-400 flex flex-col items-center justify-center hover:bg-slate-50" data-idx="1">
            <i class="fas fa-layer-group mb-1"></i> <span class="text-[10px]">Îç±</span>
        </button>
        <button onclick="switchTab(2)" class="tab-btn text-blue-600 flex flex-col items-center justify-center bg-blue-50/50" data-idx="2">
            <i class="fas fa-gamepad mb-1 text-xl"></i> <span class="text-[10px] font-bold">ÌîåÎ†àÏù¥</span>
        </button>
        <button onclick="switchTab(3)" class="tab-btn text-slate-400 flex flex-col items-center justify-center hover:bg-slate-50" data-idx="3">
            <i class="fas fa-globe mb-1"></i> <span class="text-[10px]">Î©ÄÌã∞</span>
        </button>
    </footer>

    <div id="dice-modal" class="fixed inset-0 bg-black/70 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-[2px]">
        <div class="bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl relative animate-fadeInUp">
            
            <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 z-10 p-2">
                <i class="fas fa-times text-xl"></i>
            </button>

            <div class="bg-slate-50 pt-6 pb-4 text-center border-b border-slate-100">
                <h2 id="m-name" class="text-xl font-bold text-slate-800">Dice Name</h2>
                <span id="m-grade" class="text-[10px] font-bold px-2 py-0.5 rounded bg-slate-200 text-slate-500 uppercase tracking-wider">Common</span>
            </div>

            <div class="p-5">
                <div class="flex gap-4 mb-5">
                    <div id="m-card-visual" class="w-24 aspect-[2/3] rounded-xl border flex flex-col items-center justify-center shadow-md shrink-0 relative overflow-hidden bg-slate-100">
                        <div id="m-icon" class="text-4xl mb-2">üé≤</div>
                        <div class="absolute bottom-1 right-1 text-[9px] font-bold bg-white/80 px-1 rounded text-slate-500">Lv.<span id="m-lvl-badge">1</span></div>
                    </div>
                    
                    <div class="flex-1 flex flex-col">
                        <div class="flex justify-between items-end mb-1">
                            <span class="text-xs font-bold text-slate-500">CLASS <span id="m-lvl">1</span></span>
                            <span id="m-progress-txt" class="text-[10px] text-slate-400">0/0</span>
                        </div>
                        <div class="w-full bg-slate-100 h-2 rounded-full mb-3 overflow-hidden">
                            <div id="m-bar" class="bg-blue-500 h-full w-0 transition-all duration-500"></div>
                        </div>
                        <p id="m-desc" class="text-xs text-slate-600 leading-relaxed break-keep flex-1 overflow-y-auto max-h-[60px]">
                            Description here.
                        </p>
                    </div>
                </div>

                <div id="m-stats" class="grid grid-cols-1 gap-1 mb-4 bg-slate-50 p-3 rounded-xl border border-slate-100 text-xs">
                    </div>

                <div class="flex justify-end gap-2 mb-4 text-[10px] font-bold">
                    <button onclick="togglePreview('class')" id="btn-prev-class" class="px-2 py-1.5 rounded border border-slate-200 hover:bg-green-50 hover:text-green-600 hover:border-green-300 transition-colors">
                        Lv.UP ÎØ∏Î¶¨Î≥¥Í∏∞
                    </button>
                    <button onclick="togglePreview('power')" id="btn-prev-power" class="px-2 py-1.5 rounded border border-slate-200 hover:bg-orange-50 hover:text-orange-600 hover:border-orange-300 transition-colors">
                        Power-UP ÎØ∏Î¶¨Î≥¥Í∏∞
                    </button>
                </div>

                <div class="h-px bg-slate-100 mb-4"></div>

                <div class="flex gap-2 h-12">
                    <button id="btn-upgrade" class="flex-1 bg-green-500 text-white rounded-xl font-bold text-sm shadow hover:bg-green-600 transition-colors flex flex-col items-center justify-center gap-0.5 disabled:bg-slate-300 disabled:cursor-not-allowed">
                        <span>UPGRADE</span>
                        <span class="text-[10px] opacity-80"><i class="fas fa-coins"></i> <span id="m-cost">100</span></span>
                    </button>
                    <button id="btn-equip" onclick="openEquipSelect()" class="flex-[1.5] bg-blue-600 text-white rounded-xl font-bold text-sm shadow hover:bg-blue-700 transition-colors disabled:bg-slate-300 disabled:cursor-not-allowed">
                        ÏÇ¨Ïö©
                    </button>
                </div>
            </div>

            <div id="equip-overlay" class="absolute inset-0 bg-white/95 hidden flex-col items-center justify-center z-20 animate-fadeIn">
                <h3 class="font-bold text-slate-700 mb-6">Ïñ¥ÎîîÏóê Î∞∞ÏπòÌï†ÍπåÏöî?</h3>
                <div class="flex gap-2 px-6 w-full justify-center" id="equip-targets">
                    </div>
                <button onclick="closeEquipSelect()" class="mt-8 text-slate-400 text-sm underline hover:text-slate-600">Ï∑®ÏÜå</button>
            </div>
        </div>
    </div>

    <script>
        // ================= LOGIC START =================
        const myId = sessionStorage.getItem('username');
        if (!myId) { alert("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§."); location.href = 'index.html'; }

        // State
        let inventory = [];
        let myDeck = [null, null, null, null, null];
        let currentTab = 2; 
        let selectedDiceId = null;
        let isPreviewing = null; // 'class' | 'power' | null

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
        });

        // 1. Îç∞Ïù¥ÌÑ∞ Î°úÎìú (API)
        async function fetchData() {
            try {
                // Ïã§Ï†ú API Ìò∏Ï∂ú
                const res = await fetch(`/api/dice/inventory/${myId}`);
                if(!res.ok) throw new Error("Failed to load");
                const data = await res.json();
                
                inventory = data.inventory;
                myDeck = data.deck;
                
                // UI ÏóÖÎç∞Ïù¥Ìä∏
                document.getElementById('ui-gold').innerText = data.resources.gold;
                document.getElementById('ui-gem').innerText = data.resources.gem;
                
                renderDeck();
                renderList();
            } catch(e) {
                console.error(e);
            }
        }

        // 2. Îç± Î†åÎçîÎßÅ
        function renderDeck() {
            const container = document.getElementById('deck-slots-container');
            container.innerHTML = '';
            let filledCount = 0;

            myDeck.forEach((diceId, idx) => {
                const dice = diceId ? inventory.find(d => d.id === diceId) : null;
                if(dice) filledCount++;

                const slotHtml = dice ? `
                    <div onclick="handleSlotClick(${idx})" class="relative group flex-1 aspect-[2/3] bg-${dice.color}-50 rounded-lg border border-${dice.color}-200 flex flex-col items-center justify-center cursor-pointer hover:ring-2 hover:ring-blue-400 transition-all shadow-sm">
                        <div class="text-2xl mb-1">${dice.icon_char}</div>
                        <div class="text-[9px] font-bold text-slate-600 truncate w-full text-center px-0.5">${dice.name}</div>
                        <div class="text-[8px] text-slate-400">Lv.${dice.level}</div>
                        <button onclick="updateDeck(${idx}, null); event.stopPropagation();" class="absolute -bottom-2 left-1/2 -translate-x-1/2 w-5 h-5 bg-white border border-slate-200 rounded-full flex items-center justify-center text-[10px] text-slate-400 shadow hover:text-red-500 hover:border-red-200 opacity-0 group-hover:opacity-100 transition-opacity z-10">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                ` : `
                    <div onclick="handleSlotClick(${idx})" class="flex-1 aspect-[2/3] bg-slate-50 rounded-lg border-2 border-dashed border-slate-200 flex items-center justify-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors text-slate-300">
                        <i class="fas fa-plus"></i>
                    </div>
                `;
                container.innerHTML += slotHtml;
            });

            // Í≤ΩÍ≥† ÌëúÏãú
            const alertBtn = document.getElementById('deck-alert');
            const slots = container.children;
            if(filledCount < 5) {
                alertBtn.classList.remove('hidden');
                for(let el of slots) el.classList.add('animate-pulse-red'); // Îπà Ïä¨Î°Ø Í∞ïÏ°∞
            } else {
                alertBtn.classList.add('hidden');
                for(let el of slots) el.classList.remove('animate-pulse-red');
            }
        }

        // 3. Î™©Î°ù Î†åÎçîÎßÅ
        function renderList() {
            const ownedGrid = document.getElementById('owned-dice-grid');
            const unownedGrid = document.getElementById('unowned-dice-grid');
            ownedGrid.innerHTML = ''; unownedGrid.innerHTML = '';

            inventory.forEach(dice => {
                const progress = dice.is_owned ? Math.min(100, (dice.count / dice.req_count) * 100) : 0;
                
                const cardHtml = `
                    <div onclick="openModal('${dice.id}')" class="relative flex flex-col aspect-[2/3] bg-white rounded-lg border border-slate-200 shadow-sm hover:-translate-y-1 hover:shadow-md transition-all cursor-pointer overflow-hidden group">
                        <div class="flex-[1.8] bg-${dice.color}-50 flex items-center justify-center text-3xl relative">
                            ${dice.icon_char}
                            ${dice.is_owned ? `<span class="absolute top-1 left-1 text-[8px] font-bold bg-white/80 px-1 rounded text-slate-500 shadow-sm">Lv.${dice.level}</span>` : ''}
                        </div>
                        <div class="flex-1 p-1.5 flex flex-col justify-between bg-white z-10">
                            <div class="text-[10px] font-bold text-slate-700 truncate text-center">${dice.name}</div>
                            
                            ${dice.is_owned ? `
                                <div class="w-full h-1 bg-slate-100 rounded-full overflow-hidden mt-1">
                                    <div class="bg-blue-500 h-full" style="width: ${progress}%"></div>
                                </div>
                                <div class="text-[8px] text-slate-400 text-center mt-0.5">${dice.count}/${dice.req_count}</div>
                            ` : `
                                <div class="text-[8px] text-slate-400 text-center mt-auto">ÎØ∏Î≥¥Ïú†</div>
                            `}
                        </div>
                        ${!dice.is_owned ? `<div class="absolute inset-0 bg-slate-100/50 grayscale z-20"></div>` : ''}
                    </div>
                `;

                if(dice.is_owned) ownedGrid.innerHTML += cardHtml;
                else unownedGrid.innerHTML += cardHtml;
            });
        }

        // 4. Î™®Îã¨ Î°úÏßÅ
        function openModal(id) {
            const dice = inventory.find(d => d.id === id);
            if(!dice) return;
            selectedDiceId = id;
            isPreviewing = null; // Î¶¨ÏÖã

            // Í∏∞Î≥∏ Ï†ïÎ≥¥ Ï±ÑÏö∞Í∏∞
            document.getElementById('m-name').innerText = dice.name;
            document.getElementById('m-grade').innerText = dice.grade;
            document.getElementById('m-desc').innerText = dice.description;
            document.getElementById('m-icon').innerText = dice.icon_char;
            document.getElementById('m-lvl').innerText = dice.level;
            document.getElementById('m-lvl-badge').innerText = dice.level;
            
            // Ïä§ÌÉÄÏùº (ÏÉâÏÉÅ)
            const visual = document.getElementById('m-card-visual');
            visual.className = `w-24 aspect-[2/3] rounded-xl border flex flex-col items-center justify-center shadow-md shrink-0 relative overflow-hidden bg-${dice.color}-50 border-${dice.color}-200`;

            // ÌîÑÎ°úÍ∑∏Î†àÏä§
            const pct = dice.is_owned ? (dice.count / dice.req_count) * 100 : 0;
            document.getElementById('m-bar').style.width = `${Math.min(100, pct)}%`;
            document.getElementById('m-progress-txt').innerText = dice.is_owned ? `${dice.count}/${dice.req_count}` : "-/-";

            // Ïä§ÌÉØ Î†åÎçîÎßÅ
            renderModalStats(dice);

            // Î≤ÑÌäº ÏÉÅÌÉú
            const btnEquip = document.getElementById('btn-equip');
            const btnUpgrade = document.getElementById('btn-upgrade');
            
            if(!dice.is_owned) {
                btnEquip.disabled = true; 
                btnUpgrade.disabled = true;
            } else {
                btnEquip.disabled = false;
                btnUpgrade.disabled = !(dice.count >= dice.req_count); // Ïπ¥Îìú Î∂ÄÏ°± Ïãú ÎπÑÌôúÏÑ±
            }

            // Î™®Îã¨ ÌëúÏãú
            const modal = document.getElementById('dice-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function renderModalStats(dice) {
            const statsDiv = document.getElementById('m-stats');
            let statsHtml = '';
            
            dice.stats.forEach(s => {
                let valHtml = `<span class="font-bold text-slate-700">${s.value}</span>`;
                
                // ÎØ∏Î¶¨Î≥¥Í∏∞ Î°úÏßÅ
                if (isPreviewing === 'class' && dice.preview_class[s.name]) {
                    valHtml += `<span class="text-green-500 font-bold ml-1 text-[10px] animate-pulse">${dice.preview_class[s.name]}</span>`;
                } else if (isPreviewing === 'power' && dice.preview_power[s.name]) {
                    valHtml += `<span class="text-orange-500 font-bold ml-1 text-[10px] animate-pulse">${dice.preview_power[s.name]}</span>`;
                }

                statsHtml += `
                    <div class="flex justify-between items-center py-1 border-b border-slate-100 last:border-0">
                        <div class="flex items-center gap-1.5 text-slate-500">
                            <span>${s.icon}</span> <span>${s.name}</span>
                        </div>
                        <div>${valHtml}</div>
                    </div>
                `;
            });
            statsDiv.innerHTML = statsHtml;
        }

        function togglePreview(type) {
            if (isPreviewing === type) isPreviewing = null; // ÌÜ†Í∏Ä Off
            else isPreviewing = type; // ÌÜ†Í∏Ä On
            
            const dice = inventory.find(d => d.id === selectedDiceId);
            if(dice) renderModalStats(dice);
        }

        function closeModal() {
            document.getElementById('dice-modal').classList.add('hidden');
            document.getElementById('dice-modal').classList.remove('flex');
            closeEquipSelect();
        }

        // 5. Ïû•Ï∞©(Equip) Î°úÏßÅ
        function openEquipSelect() {
            const overlay = document.getElementById('equip-overlay');
            const targetDiv = document.getElementById('equip-targets');
            targetDiv.innerHTML = '';
            
            // ÌòÑÏû¨ Îç± ÏÉÅÌÉúÎ•º Î≥¥Ïó¨Ï£ºÎäî Î≤ÑÌäº 5Í∞ú ÏÉùÏÑ±
            for(let i=0; i<5; i++) {
                const currentId = myDeck[i];
                const dice = currentId ? inventory.find(d => d.id === currentId) : null;
                const isSelected = (currentId === selectedDiceId);
                
                targetDiv.innerHTML += `
                    <button onclick="updateDeck(${i}, '${selectedDiceId}')" class="w-12 h-16 rounded-lg border-2 ${isSelected ? 'border-blue-500 bg-blue-100' : 'border-slate-300 bg-slate-50'} flex items-center justify-center hover:bg-blue-50 transition-all shadow-sm">
                        ${dice ? `<span class="text-xl">${dice.icon_char}</span>` : `<span class="text-slate-300 text-xs">+</span>`}
                    </button>
                `;
            }
            
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
        }

        function closeEquipSelect() {
            document.getElementById('equip-overlay').classList.add('hidden');
            document.getElementById('equip-overlay').classList.remove('flex');
        }

        async function updateDeck(slotIdx, diceId) {
            try {
                // API Ìò∏Ï∂ú
                const res = await fetch('/api/dice/deck/update', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: myId,
                        slot_index: slotIdx,
                        dice_id: diceId
                    })
                });
                
                if(!res.ok) throw new Error("Update failed");
                const data = await res.json();
                
                // Î°úÏª¨ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Î∞è UI Í∞±Ïã†
                myDeck = data.deck;
                renderDeck();
                
                // ÌåùÏóÖ Îã´Í∏∞
                if(diceId) closeModal();
                
            } catch(e) {
                alert("ÏÑ§Ï†ï Ï†ÄÏû• Ïã§Ìå®: " + e.message);
            }
        }
        
        // Ïä¨Î°Ø ÌÅ¥Î¶≠ (ÎπÑÏñ¥ÏûàÏúºÎ©¥ Î¨¥Î∞òÏùë, ÏûàÏúºÎ©¥ Ìï¥Îãπ Ï£ºÏÇ¨ÏúÑ Î™®Îã¨ Ïò§Ìîà)
        function handleSlotClick(idx) {
            const diceId = myDeck[idx];
            if(diceId) openModal(diceId);
            else switchTab(1); // ÎπàÏπ∏ ÎàÑÎ•¥Î©¥ Îç± ÌÉ≠ÏúºÎ°ú Ïù¥Îèô or ÌûåÌä∏
        }

        // 6. Í≤åÏûÑ ÏãúÏûë Î°úÏßÅ
        function tryStartGame() {
            const filled = myDeck.filter(d => d !== null).length;
            if(filled < 5) {
                alert("Îç±ÏùÑ ÏôÑÏÑ±Ìï¥Ïïº Í≤åÏûÑÏùÑ ÏãúÏûëÌï† Ïàò ÏûàÏäµÎãàÎã§!");
                switchTab(1); // Îç± ÌÉ≠ÏúºÎ°ú Ïù¥Îèô
                return;
            }
            // Í≤åÏûÑ ÏãúÏûë (Í∏∞Ï°¥ WebSocket Î°úÏßÅ Ìò∏Ï∂ú)
            if(window.reqStartGame) window.reqStartGame();
        }

        // 7. ÌÉ≠ Ïª®Ìä∏Î°§
        function switchTab(idx) {
            currentTab = idx;
            document.querySelectorAll('.tab-screen').forEach((el, i) => {
                if(i === idx) el.classList.add('active');
                else el.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach((btn, i) => {
                if(i === idx) {
                    btn.classList.add('text-blue-600', 'bg-blue-50/50');
                    btn.classList.remove('text-slate-400', 'hover:bg-slate-50');
                } else {
                    btn.classList.remove('text-blue-600', 'bg-blue-50/50');
                    btn.classList.add('text-slate-400', 'hover:bg-slate-50');
                }
            });
            
            // Îç± ÌÉ≠ ÏßÑÏûÖ Ïãú Îç∞Ïù¥ÌÑ∞ Í∞±Ïã†
            if(idx === 1) fetchData();
        }

        function moveTab(dir) {
            let next = currentTab + dir;
            if(next < 0) next = 0;
            if(next > 3) next = 3;
            switchTab(next);
        }

        // Îí§Î°úÍ∞ÄÍ∏∞
        function exitGame() {
            if(confirm("Î°úÎπÑÎ°ú ÎèåÏïÑÍ∞ÄÏãúÍ≤†ÏäµÎãàÍπå?")) {
                location.href = 'home.html';
            }
        }
    </script>
</body>
</html>