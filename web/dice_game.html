<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playground V3 - ë‹¤ì´ìŠ¤ ë””íœìŠ¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; overflow: hidden; }
        .tab-screen { display: none; height: 100%; width: 100%; flex-direction: column; }
        .tab-screen.active { display: flex; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-pulse-red { animation: pulseRed 2s infinite; }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col select-none">

    <nav class="h-14 bg-white flex justify-between items-center px-4 shadow-sm z-50 shrink-0 border-b border-slate-200">
        <div class="flex items-center gap-3">
            <button onclick="exitGame()" class="text-slate-400 hover:text-red-500 transition-colors">
                <i class="fas fa-chevron-left text-lg"></i>
            </button>
            <h1 class="text-lg font-bold text-blue-600">Dice Defense</h1>
        </div>
        <div class="flex items-center gap-2">
            <div class="bg-slate-100 px-2 py-1 rounded-md text-xs font-bold text-slate-600 border border-slate-200">
                <i class="fas fa-coins text-yellow-500 mr-1"></i> <span id="ui-gold">0</span>
            </div>
            <div class="bg-slate-100 px-2 py-1 rounded-md text-xs font-bold text-slate-600 border border-slate-200">
                <i class="fas fa-gem text-blue-400 mr-1"></i> <span id="ui-gem">0</span>
            </div>
        </div>
    </nav>

    <main class="flex-1 relative w-full max-w-2xl mx-auto overflow-hidden bg-slate-50">
        
        <div id="screen-0" class="tab-screen items-center justify-center">
            <i class="fas fa-store text-5xl text-orange-200 mb-3"></i>
            <h2 class="text-xl font-bold text-slate-600">ìƒì </h2>
            <p class="text-slate-400 text-xs">ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</p>
        </div>

        <div id="screen-1" class="tab-screen">
            <div class="bg-white p-5 pb-3 shadow-sm border-b border-slate-200 z-10">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-bold text-slate-700">BATTLE DECK</h3>
                    <button id="deck-alert" onclick="alert('ì „íˆ¬ë¥¼ ì‹œì‘í•˜ë ¤ë©´ ë± 5ì¹¸ì„ ëª¨ë‘ ì±„ì›Œì•¼ í•©ë‹ˆë‹¤.')" class="hidden text-red-500 text-xs font-bold animate-pulse px-2 py-0.5 rounded transition-colors">
                        <i class="fas fa-exclamation-circle mr-1"></i> ë± ì„¤ì • í•„ìš”
                    </button>
                </div>
                <div class="flex gap-2 h-24 sm:h-28" id="deck-slots-container"></div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 scrollbar-hide pb-20">
                <h4 class="text-xs font-bold text-slate-500 mb-2 px-1">ë³´ìœ  ì£¼ì‚¬ìœ„</h4>
                <div id="owned-dice-grid" class="grid grid-cols-4 gap-2 mb-6"></div>
                <h4 class="text-xs font-bold text-slate-400 mb-2 px-1">ë¯¸ë³´ìœ </h4>
                <div id="unowned-dice-grid" class="grid grid-cols-4 gap-2 opacity-60 grayscale"></div>
            </div>
        </div>

        <div id="screen-2" class="tab-screen active bg-white">
            <div id="lobby-view" class="flex flex-col items-center justify-center h-full w-full p-6">
                <h2 class="text-3xl font-extrabold text-slate-800 tracking-tight mb-1">BATTLE READY</h2>
                <p class="text-slate-400 text-sm mb-10">ìµœê°•ì˜ ë±ìœ¼ë¡œ ì ì„ ë§‰ì•„ë‚´ì„¸ìš”!</p>
                <button onclick="tryStartGame()" class="w-full max-w-xs py-4 bg-blue-600 text-white rounded-2xl font-bold text-lg shadow-lg hover:scale-[1.02] transition-all">GAME START</button>
            </div>
            <div id="game-view" class="hidden w-full h-full relative bg-slate-800 flex items-center justify-center">
                <canvas id="gameCanvas" width="500" height="888" class="w-full h-full max-w-[500px] aspect-[9/16]"></canvas>
            </div>
        </div>

        <div id="screen-3" class="tab-screen items-center justify-center">
            <i class="fas fa-users text-5xl text-green-200 mb-3"></i>
            <h2 class="text-xl font-bold text-slate-600">ë©€í‹°í”Œë ˆì´</h2>
            <p class="text-slate-400 text-xs">ì¤€ë¹„ ì¤‘...</p>
        </div>
    </main>

    <footer class="h-16 bg-white border-t border-slate-100 grid grid-cols-4 shrink-0 z-50">
        <button onclick="switchTab(0)" class="tab-btn text-slate-400 hover:bg-slate-50 flex flex-col items-center justify-center" data-idx="0"><i class="fas fa-store mb-1"></i><span class="text-[10px]">ìƒì </span></button>
        <button onclick="switchTab(1)" class="tab-btn text-slate-400 hover:bg-slate-50 flex flex-col items-center justify-center" data-idx="1"><i class="fas fa-layer-group mb-1"></i><span class="text-[10px]">ë±</span></button>
        <button onclick="switchTab(2)" class="tab-btn text-blue-600 bg-blue-50/50 flex flex-col items-center justify-center" data-idx="2"><i class="fas fa-gamepad mb-1 text-xl"></i><span class="text-[10px] font-bold">í”Œë ˆì´</span></button>
        <button onclick="switchTab(3)" class="tab-btn text-slate-400 hover:bg-slate-50 flex flex-col items-center justify-center" data-idx="3"><i class="fas fa-globe mb-1"></i><span class="text-[10px]">ë©€í‹°</span></button>
    </footer>

    <div id="dice-modal" class="fixed inset-0 bg-black/70 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-[2px]">
        <div class="bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl relative">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 z-10 p-2"><i class="fas fa-times text-xl"></i></button>
            <div class="bg-slate-50 pt-6 pb-4 text-center border-b border-slate-100">
                <h2 id="m-name" class="text-xl font-bold text-slate-800">Dice</h2>
                <span id="m-grade" class="text-[10px] font-bold px-2 py-0.5 rounded bg-slate-200 text-slate-500 uppercase">Common</span>
            </div>
            <div class="p-5">
                <div class="flex gap-4 mb-5">
                    <div id="m-card-visual" class="w-24 aspect-[2/3] rounded-xl border flex flex-col items-center justify-center shadow-md shrink-0 relative overflow-hidden bg-slate-100">
                        <div id="m-icon" class="text-4xl mb-2">ğŸ²</div>
                        <div class="absolute bottom-1 right-1 text-[9px] font-bold bg-white/80 px-1 rounded text-slate-500">Lv.<span id="m-lvl-badge">1</span></div>
                    </div>
                    <div class="flex-1 flex flex-col">
                        <div class="flex justify-between items-end mb-1">
                            <span class="text-xs font-bold text-slate-500">CLASS <span id="m-lvl">1</span></span>
                            <span id="m-progress-txt" class="text-[10px] text-slate-400">0/1</span>
                        </div>
                        <div class="w-full bg-slate-100 h-2 rounded-full mb-3 overflow-hidden">
                            <div id="m-bar" class="bg-blue-500 h-full w-0 transition-all duration-500"></div>
                        </div>
                        <p id="m-desc" class="text-xs text-slate-600 leading-relaxed break-keep max-h-[60px] overflow-y-auto"></p>
                    </div>
                </div>
                <div id="m-stats" class="grid grid-cols-1 gap-1 mb-4 bg-slate-50 p-3 rounded-xl border border-slate-100 text-xs"></div>
                
                <div class="flex gap-2 h-12">
                    <button id="btn-upgrade" class="flex-1 bg-green-500 text-white rounded-xl font-bold text-sm shadow hover:bg-green-600 disabled:bg-slate-300 disabled:cursor-not-allowed">
                        <span>UPGRADE</span>
                    </button>
                    <button id="btn-equip" onclick="openEquipSelect()" class="flex-[1.5] bg-blue-600 text-white rounded-xl font-bold text-sm shadow hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed">ì‚¬ìš©</button>
                </div>
            </div>
            <div id="equip-overlay" class="absolute inset-0 bg-white/95 hidden flex-col items-center justify-center z-20">
                <h3 class="font-bold text-slate-700 mb-6">ì–´ë””ì— ë°°ì¹˜í• ê¹Œìš”?</h3>
                <div class="flex gap-2 px-6 w-full justify-center" id="equip-targets"></div>
                <button onclick="closeEquipSelect()" class="mt-8 text-slate-400 text-sm underline">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
        const myId = sessionStorage.getItem('username');
        if (!myId) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); location.href = 'index.html'; }

        let inventory = [], myDeck = [], selectedDiceId = null;

        document.addEventListener('DOMContentLoaded', fetchData);

        async function fetchData() {
            try {
                // api.pyosh.cloud ë“± ì™¸ë¶€ ì ‘ì† í™˜ê²½ ê³ ë ¤í•˜ì—¬ ìƒëŒ€ ê²½ë¡œ ì‚¬ìš©
                const res = await fetch(`/api/dice/inventory/${myId}`);
                if (!res.ok) throw new Error("API Load Failed");
                const data = await res.json();
                inventory = data.inventory;
                myDeck = data.deck;
                
                document.getElementById('ui-gold').innerText = data.resources.gold;
                document.getElementById('ui-gem').innerText = data.resources.gem;
                renderDeck(); renderList();
            } catch (e) {
                console.error(e);
                // ì£¼ì‚¬ìœ„ ë¡œë”© ì‹¤íŒ¨ ì‹œ íƒ­ì— í‘œì‹œ
                document.getElementById('screen-1').innerHTML += `<div class='p-4 text-red-500 text-center'>ë°ì´í„° ë¡œë”© ì‹¤íŒ¨<br><span class='text-xs'>${e.message}</span></div>`;
            }
        }

        function renderDeck() {
            const container = document.getElementById('deck-slots-container');
            container.innerHTML = '';
            let filledCount = 0;
            myDeck.forEach((diceId, idx) => {
                const dice = diceId ? inventory.find(d => d.id === diceId) : null;
                if(dice) filledCount++;
                container.innerHTML += dice ? `
                    <div onclick="openModal('${dice.id}')" class="relative group flex-1 aspect-[2/3] bg-${dice.color}-50 rounded-lg border border-${dice.color}-200 flex flex-col items-center justify-center cursor-pointer hover:ring-2 hover:ring-blue-400 transition-all shadow-sm">
                        <div class="text-2xl mb-1">${dice.icon_char}</div>
                        <div class="text-[9px] font-bold text-slate-600 truncate w-full text-center">${dice.name}</div>
                        <div class="text-[8px] text-slate-400">Lv.${dice.level}</div>
                        <button onclick="updateDeck(${idx}, null); event.stopPropagation();" class="absolute -bottom-2 left-1/2 -translate-x-1/2 w-5 h-5 bg-white border border-slate-200 rounded-full flex items-center justify-center text-[10px] text-slate-400 shadow hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity z-10"><i class="fas fa-times"></i></button>
                    </div>` : `
                    <div onclick="switchTab(1)" class="flex-1 aspect-[2/3] bg-slate-50 rounded-lg border-2 border-dashed border-slate-200 flex items-center justify-center cursor-pointer hover:border-blue-400 text-slate-300"><i class="fas fa-plus"></i></div>`;
            });
            document.getElementById('deck-alert').classList.toggle('hidden', filledCount >= 5);
        }

        function renderList() {
            const owned = document.getElementById('owned-dice-grid');
            const unowned = document.getElementById('unowned-dice-grid');
            owned.innerHTML = ''; unowned.innerHTML = '';

            inventory.forEach(dice => {
                const pct = dice.is_owned ? Math.min(100, (dice.count / dice.req_count) * 100) : 0;
                const html = `
                    <div onclick="openModal('${dice.id}')" class="relative flex flex-col aspect-[2/3] bg-white rounded-lg border border-slate-200 shadow-sm hover:-translate-y-1 transition-all cursor-pointer overflow-hidden">
                        <div class="flex-[1.8] bg-${dice.color}-50 flex items-center justify-center text-3xl relative">
                            ${dice.icon_char}
                            ${dice.is_owned ? `<span class="absolute top-1 left-1 text-[8px] font-bold bg-white/80 px-1 rounded text-slate-500">Lv.${dice.level}</span>` : ''}
                        </div>
                        <div class="flex-1 p-1.5 flex flex-col justify-between bg-white z-10">
                            <div class="text-[10px] font-bold text-slate-700 truncate text-center">${dice.name}</div>
                            ${dice.is_owned ? `<div class="w-full h-1 bg-slate-100 rounded-full overflow-hidden mt-1"><div class="bg-blue-500 h-full" style="width: ${pct}%"></div></div>` : `<div class="text-[8px] text-slate-400 text-center mt-auto">ë¯¸ë³´ìœ </div>`}
                        </div>
                        ${!dice.is_owned ? `<div class="absolute inset-0 bg-slate-100/50 grayscale z-20"></div>` : ''}
                    </div>`;
                (dice.is_owned ? owned : unowned).innerHTML += html;
            });
        }

        function openModal(id) {
            const dice = inventory.find(d => d.id === id);
            if(!dice) return;
            selectedDiceId = id;

            document.getElementById('m-name').innerText = dice.name;
            document.getElementById('m-grade').innerText = dice.grade;
            document.getElementById('m-desc').innerText = dice.description;
            document.getElementById('m-icon').innerText = dice.icon_char;
            document.getElementById('m-lvl').innerText = dice.level;
            document.getElementById('m-lvl-badge').innerText = dice.level;
            document.getElementById('m-card-visual').className = `w-24 aspect-[2/3] rounded-xl border flex flex-col items-center justify-center shadow-md shrink-0 relative overflow-hidden bg-${dice.color}-50 border-${dice.color}-200`;

            const pct = dice.is_owned ? Math.min(100, (dice.count / dice.req_count) * 100) : 0;
            document.getElementById('m-bar').style.width = `${pct}%`;
            document.getElementById('m-progress-txt').innerText = dice.is_owned ? `${dice.count}/${dice.req_count}` : "-/-";

            const statsDiv = document.getElementById('m-stats');
            statsDiv.innerHTML = dice.stats.map(s => `<div class="flex justify-between py-1 border-b border-slate-100 last:border-0"><span class="text-slate-500">${s.icon} ${s.name}</span><span class="font-bold text-slate-700">${s.value}</span></div>`).join('');

            const btnEquip = document.getElementById('btn-equip');
            const btnUpgrade = document.getElementById('btn-upgrade');
            btnEquip.disabled = !dice.is_owned;
            btnUpgrade.disabled = !(dice.is_owned && dice.count >= dice.req_count);

            document.getElementById('dice-modal').classList.remove('hidden');
            document.getElementById('dice-modal').classList.add('flex');
        }

        function closeModal() { document.getElementById('dice-modal').classList.add('hidden'); document.getElementById('dice-modal').classList.remove('flex'); closeEquipSelect(); }

        function openEquipSelect() {
            const targetDiv = document.getElementById('equip-targets');
            targetDiv.innerHTML = '';
            for(let i=0; i<5; i++) {
                const dice = myDeck[i] ? inventory.find(d => d.id === myDeck[i]) : null;
                const isSel = (myDeck[i] === selectedDiceId);
                targetDiv.innerHTML += `<button onclick="updateDeck(${i}, '${selectedDiceId}')" class="w-12 h-16 rounded-lg border-2 ${isSel ? 'border-blue-500 bg-blue-100' : 'border-slate-300 bg-slate-50'} flex items-center justify-center hover:bg-blue-50 transition-all">${dice ? `<span class="text-xl">${dice.icon_char}</span>` : `<span class="text-slate-300 text-xs">+</span>`}</button>`;
            }
            document.getElementById('equip-overlay').classList.remove('hidden');
            document.getElementById('equip-overlay').classList.add('flex');
        }
        function closeEquipSelect() { document.getElementById('equip-overlay').classList.add('hidden'); document.getElementById('equip-overlay').classList.remove('flex'); }

        async function updateDeck(idx, id) {
            try {
                const res = await fetch('/api/dice/deck/update', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: myId, slot_index: idx, dice_id: id})
                });
                if(!res.ok) throw new Error();
                const data = await res.json();
                myDeck = data.deck;
                renderDeck();
                if(id) closeModal();
            } catch(e) { alert("ì €ì¥ ì‹¤íŒ¨"); }
        }

        function switchTab(idx) {
            document.querySelectorAll('.tab-screen').forEach((el, i) => { el.classList.toggle('active', i === idx); });
            document.querySelectorAll('.tab-btn').forEach((btn, i) => {
                const isActive = i === idx;
                btn.classList.toggle('text-blue-600', isActive);
                btn.classList.toggle('bg-blue-50/50', isActive);
                btn.classList.toggle('text-slate-400', !isActive);
            });
            if(idx === 1) fetchData();
        }
        
        function tryStartGame() {
            if(myDeck.filter(d => d !== null).length < 5) { alert("ë±ì„ ì™„ì„±í•´ì£¼ì„¸ìš”!"); switchTab(1); return; }
            if(window.reqStartGame) window.reqStartGame();
        }
        function exitGame() { if(confirm("ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) location.href = 'home.html'; }
    </script>
</body>
</html>