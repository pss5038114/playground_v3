<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dice Defense - Playground V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; overflow: hidden; }
        .tab-content { display: none; height: calc(100vh - 140px); overflow-y: auto; }
        .tab-content.active { display: flex; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        #game-canvas { background: #334155; border-radius: 12px; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
        .text-Common { color: #94a3b8; } .text-Rare { color: #3b82f6; } .text-Hero { color: #a855f7; } .text-Legend { color: #eab308; }
        .border-Common { border-color: #e2e8f0; } .border-Rare { border-color: #bfdbfe; } .border-Hero { border-color: #e9d5ff; } .border-Legend { border-color: #fef08a; }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col">

    <nav class="flex-none h-16 bg-white flex justify-between items-center px-4 shadow-sm z-50">
        <div class="flex items-center gap-3">
            <button onclick="location.href='home.html'" class="text-slate-500 hover:text-blue-600 transition-colors"><i class="fas fa-arrow-left text-xl"></i></button>
            <h1 class="text-lg font-bold text-slate-800 select-none">Dice Defense</h1>
        </div>
        <div class="flex gap-2 text-xs font-bold text-slate-600 bg-slate-100 px-3 py-1.5 rounded-full">
            <div class="flex items-center gap-1"><i class="fas fa-gem text-blue-500"></i> <span id="res-gem">0</span></div>
            <div class="w-px h-3 bg-slate-300"></div>
            <div class="flex items-center gap-1"><i class="fas fa-coins text-yellow-500"></i> <span id="res-gold">0</span></div>
            <div class="w-px h-3 bg-slate-300"></div>
            <div class="flex items-center gap-1"><i class="fas fa-ticket-alt text-purple-500"></i> <span id="res-ticket">0</span></div>
        </div>
    </nav>

    <main class="flex-1 relative w-full max-w-lg mx-auto bg-slate-50 shadow-2xl overflow-hidden md:border-x md:border-slate-200">
        <div id="tab-shop" class="tab-content flex-col items-center p-4 space-y-6">
            <div class="w-full bg-white rounded-2xl p-4 shadow-sm border border-slate-200">
                <h3 class="font-bold text-slate-800 text-lg mb-4">ğŸ² ì£¼ì‚¬ìœ„ ì†Œí™˜</h3>
                <div class="flex gap-3">
                    <button onclick="pullGacha(1)" class="flex-1 bg-slate-50 border border-slate-200 rounded-xl p-4 flex flex-col items-center hover:bg-slate-100 transition-all">
                        <div class="text-4xl mb-2">ğŸ“¦</div>
                        <div class="text-sm font-bold text-slate-700">1íšŒ ì†Œí™˜</div>
                        <div class="text-xs text-purple-600 font-bold mt-1">ğŸ« 1</div>
                    </button>
                    <button onclick="pullGacha(10)" class="flex-1 bg-gradient-to-br from-indigo-50 to-purple-50 border border-indigo-100 rounded-xl p-4 flex flex-col items-center hover:shadow-md transition-all">
                        <div class="text-4xl mb-2">ğŸ</div>
                        <div class="text-sm font-bold text-indigo-700">11íšŒ ì†Œí™˜</div>
                        <div class="text-xs text-purple-600 font-bold mt-1">ğŸ« 10</div>
                    </button>
                </div>
            </div>
            <div class="w-full bg-slate-100 rounded-2xl p-4">
                <h3 class="font-bold text-slate-600 text-sm mb-3">í…ŒìŠ¤íŠ¸ìš© ë¬´ë£Œ ì¶©ì „ì†Œ</h3>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="addResource('gem', 500)" class="bg-white py-2 rounded-lg text-xs font-bold text-blue-500 shadow-sm">ğŸ’ ë³´ì„+500</button>
                    <button onclick="addResource('gold', 1000)" class="bg-white py-2 rounded-lg text-xs font-bold text-yellow-600 shadow-sm">ğŸ’° ê³¨ë“œ+1000</button>
                    <button onclick="addResource('ticket', 10)" class="bg-white py-2 rounded-lg text-xs font-bold text-purple-600 shadow-sm">ğŸ« í‹°ì¼“+10</button>
                </div>
            </div>
        </div>

        <div id="tab-deck" class="tab-content flex-col p-4">
            <div class="flex justify-between items-end mb-4 px-1">
                <h4 class="text-xs font-bold text-slate-500">ì „ì²´ ì£¼ì‚¬ìœ„ ëª©ë¡</h4>
                <button onclick="fetchDiceList()" class="text-[10px] text-blue-500">ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div id="dice-list-container" class="space-y-3">
                <div class="text-center py-10 text-slate-400">ë¡œë”© ì¤‘...</div>
            </div>
        </div>

        <div id="tab-battle" class="tab-content active flex-col p-4">
            <div class="flex-1 flex flex-col items-center justify-center bg-slate-50 border rounded-2xl">
                <div class="text-6xl mb-4 animate-bounce">ğŸ²</div>
                <h2 class="text-2xl font-bold">DICE DEFENSE</h2>
                <button onclick="startGame('pve')" class="mt-8 px-12 py-4 bg-blue-600 text-white font-bold rounded-2xl">ê²Œì„ ì‹œì‘</button>
            </div>
        </div>

        <div id="tab-event" class="tab-content flex-col p-4 text-center text-slate-400">ì´ë²¤íŠ¸ ì¤€ë¹„ ì¤‘</div>
        <div id="tab-clan" class="tab-content flex-col p-4 text-center text-slate-400">í´ëœ ê¸°ëŠ¥ ì¤€ë¹„ ì¤‘</div>
    </main>

    <nav class="flex-none h-20 bg-white border-t border-slate-200 flex justify-between items-center px-1 pb-2 shadow-[0_-5px_20px_rgba(0,0,0,0.05)] z-50">
        <button onclick="switchTab('shop')" class="nav-btn flex-1 flex flex-col items-center gap-1 text-slate-400" data-target="tab-shop"><i class="fas fa-store text-xl"></i><span class="text-[10px] font-bold">ìƒì </span></button>
        <button onclick="switchTab('deck')" class="nav-btn flex-1 flex flex-col items-center gap-1 text-slate-400" data-target="tab-deck"><i class="fas fa-th-large text-xl"></i><span class="text-[10px] font-bold">ë±</span></button>
        <div class="w-16 relative flex justify-center"><button onclick="switchTab('battle')" class="nav-btn absolute -top-10 w-16 h-16 bg-blue-600 rounded-full flex flex-col items-center justify-center text-white ring-4 ring-white shadow-lg shadow-blue-200" data-target="tab-battle"><i class="fas fa-gamepad text-2xl"></i></button></div>
        <button onclick="switchTab('event')" class="nav-btn flex-1 flex flex-col items-center gap-1 text-slate-400" data-target="tab-event"><i class="fas fa-gift text-xl"></i><span class="text-[10px] font-bold">ì´ë²¤íŠ¸</span></button>
        <button onclick="switchTab('clan')" class="nav-btn flex-1 flex flex-col items-center gap-1 text-slate-400" data-target="tab-clan"><i class="fas fa-users text-xl"></i><span class="text-[10px] font-bold">í´ëœ</span></button>
    </nav>

    <div id="gacha-modal" class="fixed inset-0 bg-black/80 hidden z-[100] flex flex-col items-center justify-center p-6 backdrop-blur-sm">
        <h2 class="text-white text-2xl font-bold mb-6 animate-bounce">ğŸ íšë“ ì™„ë£Œ!</h2>
        <div id="gacha-result-grid" class="grid grid-cols-4 gap-3 w-full max-w-sm mb-8"></div>
        <button onclick="closeGachaModal()" class="bg-white text-slate-800 font-bold px-8 py-3 rounded-full hover:bg-slate-100 transition-colors shadow-lg">í™•ì¸</button>
    </div>

    <script>
        // [í•µì‹¬ í•´ê²°ì±…] ë°±ì—”ë“œ ì£¼ì†Œë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ Pagesì™€ Tunnel ê°„ í†µì‹  ì˜¤ë¥˜ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.
        const BACKEND_URL = "https://pyosh.cloud";
        const API_AUTH = `${BACKEND_URL}/api/auth`;
        const API_DICE = `${BACKEND_URL}/api/dice`;
        const myId = sessionStorage.getItem('username');

        const DICE_ASSETS = {
            "fire": { icon: "ğŸ”¥", color: "text-red-500" }, "electric": { icon: "âš¡", color: "text-yellow-500" },
            "wind": { icon: "ğŸŒªï¸", color: "text-green-500" }, "poison": { icon: "â˜ ï¸", color: "text-purple-500" },
            "ice": { icon: "ğŸ§Š", color: "text-blue-400" }, "mining": { icon: "â›ï¸", color: "text-slate-500" },
            "light": { icon: "âœ¨", color: "text-yellow-300" }, "death": { icon: "ğŸ’€", color: "text-slate-800" },
            "adapt": { icon: "ğŸ­", color: "text-pink-500" }, "typhoon": { icon: "ğŸŒ€", color: "text-indigo-500" }
        };
        const RARITY_MAP = { "Common": "ì¼ë°˜", "Rare": "í¬ê·€", "Hero": "ì˜ì›…", "Legend": "ì „ì„¤" };

        window.onload = async function() {
            if(!myId) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); location.href='index.html'; return; }
            // ì„œë²„ ìƒíƒœ í™•ì¸
            try { await fetch(`${BACKEND_URL}/api/health`); } catch(e) { console.error("ë°±ì—”ë“œ ì—°ê²° ì‹¤íŒ¨", e); }
            fetchMyResources();
        };

        function switchTab(name) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${name}`).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const isActive = btn.dataset.target === `tab-${name}`;
                if(isActive && !btn.classList.contains('bg-blue-600')) btn.classList.add('text-blue-600');
                else btn.classList.remove('text-blue-600');
            });
            if(name === 'deck') fetchDiceList();
        }

        async function fetchMyResources() {
            if(!myId) return;
            try {
                const res = await fetch(`${API_AUTH}/profile/${myId}`);
                if(res.ok) {
                    const data = await res.json();
                    document.getElementById('res-gem').innerText = data.gems.toLocaleString();
                    document.getElementById('res-gold').innerText = data.gold.toLocaleString();
                    document.getElementById('res-ticket').innerText = data.tickets.toLocaleString();
                }
            } catch(e) { console.error(e); }
        }

        async function addResource(type, amount) {
            try {
                const res = await fetch(`${API_AUTH}/add-resource`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: myId, type: type, amount: amount })
                });
                if(res.ok) { fetchMyResources(); }
                else { alert(`ì—ëŸ¬ ë°œìƒ: ${res.status}`); }
            } catch(e) { alert("ì„œë²„ í†µì‹  ì‹¤íŒ¨"); }
        }

        async function pullGacha(count) {
            if(!confirm(`í‹°ì¼“ ${count}ì¥ì„ ì‚¬ìš©í•˜ì—¬ ì†Œí™˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            try {
                const res = await fetch(`${API_DICE}/gacha`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: myId, draw_count: count })
                });
                if(res.ok) {
                    const data = await res.json();
                    fetchMyResources();
                    showGachaResults(data.results);
                } else { const d = await res.json(); alert(d.detail); }
            } catch(e) { alert("ì„œë²„ ì˜¤ë¥˜"); }
        }

        function showGachaResults(results) {
            const grid = document.getElementById('gacha-result-grid');
            grid.innerHTML = "";
            results.forEach((item, index) => {
                const asset = DICE_ASSETS[item.id] || { icon: "ğŸ²", color: "text-slate-500" };
                const el = document.createElement('div');
                el.className = `bg-white rounded-xl p-3 flex flex-col items-center justify-center shadow-lg border-2 border-${item.rarity}`;
                el.innerHTML = `<div class="text-3xl mb-1 ${asset.color}">${asset.icon}</div><div class="text-[10px] font-bold text-slate-700 truncate w-full text-center">${item.name}</div><div class="text-[9px] font-bold text-${item.rarity} mt-0.5">${RARITY_MAP[item.rarity]}</div>`;
                grid.appendChild(el);
            });
            document.getElementById('gacha-modal').classList.remove('hidden');
            document.getElementById('gacha-modal').style.display = 'flex';
        }

        function closeGachaModal() { document.getElementById('gacha-modal').classList.add('hidden'); }

        async function fetchDiceList() {
            const container = document.getElementById('dice-list-container');
            try {
                const res = await fetch(`${API_DICE}/list/${myId}`);
                if(!res.ok) throw new Error();
                const list = await res.json();
                container.innerHTML = list.map(dice => {
                    const asset = DICE_ASSETS[dice.id] || { icon: "ğŸ²", color: "text-slate-500" };
                    const isLocked = dice.level === 0;
                    return `<div class="bg-white rounded-xl p-3 shadow-sm border border-slate-100 flex items-center gap-4 ${isLocked ? 'opacity-70 grayscale-[0.5]' : ''}">
                        <div class="w-14 h-14 rounded-xl bg-slate-50 flex items-center justify-center text-3xl border border-${dice.rarity}"><span class="${asset.color}">${asset.icon}</span></div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2"><span class="font-bold text-slate-700 text-sm">${dice.name}</span><span class="text-[10px] px-1.5 py-0.5 rounded bg-slate-100 font-bold text-${dice.rarity}">${RARITY_MAP[dice.rarity]}</span>${!isLocked ? `<span class="text-[10px] bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded font-bold">Lv.${dice.level}</span>` : ''}</div>
                            <div class="mt-1"><div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden mt-1"><div class="bg-green-500 h-full" style="width:${Math.min(100, (dice.card_count/dice.req_card)*100)}%"></div></div><div class="flex justify-between text-[9px] mt-0.5 text-slate-400"><span>${dice.card_count}/${dice.req_card}</span><span>ğŸ’° ${dice.req_gold}</span></div></div>
                        </div>
                        <div><button onclick="upgradeDice('${dice.id}')" class="px-3 py-1.5 text-xs font-bold rounded-lg ${dice.can_upgrade ? 'bg-green-500 text-white' : 'bg-slate-100 text-slate-400'}" ${!dice.can_upgrade ? 'disabled' : ''}>${isLocked ? 'ì ê¸ˆí•´ì œ' : 'ê°•í™”'}</button></div>
                    </div>`;
                }).join('');
            } catch(e) { container.innerHTML = `<div class="text-center text-red-400 p-4">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>`; }
        }

        async function upgradeDice(diceId) {
            try {
                const res = await fetch(`${API_DICE}/upgrade`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: myId, dice_id: diceId })
                });
                if(res.ok) { fetchMyResources(); fetchDiceList(); }
                else { const d = await res.json(); alert(d.detail); }
            } catch(e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
        }

        function startGame(mode) { alert("ì „íˆ¬ ë¡œì§ì€ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ êµ¬í˜„ë  ì˜ˆì •ì…ë‹ˆë‹¤!"); }
    </script>
</body>
</html>